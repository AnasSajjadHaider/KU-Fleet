name: Deploy to EC2 (dev)

on:
  push:
    branches: [ develop ]   # change to main if you prefer

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Sync project to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}      # e.g., ubuntu
          EC2_HOST: ${{ secrets.EC2_HOST }}      # IP or hostname
          REMOTE_DIR: ${{ secrets.EC2_REMOTE_DIR }} # e.g. ~/kufleet-dev
        run: |
          echo "Syncing files to ${EC2_USER}@${EC2_HOST}:${REMOTE_DIR}"
          rsync -azh --delete --exclude node_modules --exclude dist ./ ${EC2_USER}@${EC2_HOST}:${REMOTE_DIR}

      - name: Remote: install deps & restart (pm2)
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.EC2_REMOTE_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} <<'SSH'
            set -e
            cd "$REMOTE_DIR"

            # ensure Node 18+ installed - optional (comment if already installed)
            if ! node -v | grep -q "v18"; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs build-essential
            fi

            # install
            npm ci

            # build (if you use TS build)
            npm run build || true

            # ensure pm2 present
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi

            # stop old, start new with ecosystem or direct file
            pm2 stop kufleet || true
            pm2 start ecosystem.config.js --only kufleet || pm2 start dist/core/server.js --name kufleet
            pm2 save
          SSH
